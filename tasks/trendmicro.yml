---
- name: Get trendmicro latest .deb package from internal network
  get_url:
    url: "{{ trendmicro_deb_url }}"
    dest: /tmp/trendmicro.deb
    validate_certs: no
  register: result
  retries: 3
  delay: 30
  until: result is success

- name: Install trendmicro
  apt:
    deb: "/tmp/trendmicro.deb"
  register: trendmicro_installed

- name: sleep 10 seconds
  command: sleep 10
  when: trendmicro_installed is changed
  tags:
    - skip_ansible_lint

- name: register trenmicro agent
  command: /opt/ds_agent/dsa_control -a dsm://dsm.sec.helix.gsa.gov:4120/ "policyid:{{ trendmicro_policy_id }}"
  # TODO clarify if jumpbox should have a policy id
  # In general, when trendmicro_enabled is true, a policy id should be set for
  # each host in the environment. Currently, jumpboxes do not have a
  # trendmicro policy. If we find that jumpboxes _should_ have a policy id,
  # then we should make an assertion.
  when: trendmicro_policy_id is defined
